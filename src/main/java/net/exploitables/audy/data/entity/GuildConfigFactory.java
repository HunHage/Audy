package net.exploitables.audy.data.entity;

import discord4j.core.object.entity.Guild;
import net.exploitables.audy.AudyDatabase;
import net.exploitables.audy.data.Pair;
import org.jdbi.v3.core.mapper.RowMapperFactory;
import org.jdbi.v3.core.mapper.reflect.ConstructorMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

/**
 * Factory for {@link GuildConfig}.
 *
 * Various methods of obtaining data from SQL to construct instances as well as specific methods
 *  to access data in a particular way where an entire
 */
// We should explicitly handle any issue that occurs to provide proper feedback.
@SuppressWarnings("RedundantThrows")
public class GuildConfigFactory {
    private static final Logger logger = LoggerFactory.getLogger(GuildConfigFactory.class);
    private static final RowMapperFactory mapper = ConstructorMapper.factory(GuildConfig.class);

    /**
     * @param guild the guild to get saved configuration for
     * @return a GuildConfig instance representing data currently saved in SQL, created if needed
     * @throws Exception when any issue occurs
     */
    public static GuildConfig getGuildConfigFromSQL(Guild guild) throws Exception {
        logger.debug("Loading GuildConfig for ID:" + guild.getId().asLong());
        Optional<GuildConfig> sqlData = AudyDatabase.getJdbi().withHandle(handle -> {
            handle.registerRowMapper(mapper);
            return handle.createQuery("SELECT * FROM guild_data WHERE guild_id = :guild_id")
                .bind("guild_id", guild.getId().asLong())
                .mapTo(GuildConfig.class)
                .findOne();
        });

        if (sqlData.isPresent()) {
            logger.debug("GuildConfig for ID:" + guild.getId().asLong() + " retrieved.");
            return sqlData.get();
        } else {
            return createNewGuildConfig(guild);
        }
    }

    /**
     * Create a new {@link GuildConfig} for the provided guild and insert a row into the SQL database.
     * Should only be called when no entry for this guild exists.
     *
     * @param guild guild to create data for
     * @return a newly created {@link GuildConfig} object that has been created in the SQL database
     * @throws Exception when any issue occurs
     */
    private static GuildConfig createNewGuildConfig(Guild guild) throws Exception {
        logger.debug("Creating GuildConfig for ID:" + guild.getId().asLong() + " ...");
        GuildConfig guildConfig = new GuildConfig(guild);
        AudyDatabase.getJdbi().useHandle(handle ->
            handle.createUpdate("INSERT INTO guild_data (" +
            " guild_id," +
            " joined," +
            " prefix" +
                " ) VALUES (" +
            " :guild_id," +
            " :joined," +
            " :prefix" +
            ");")
            .bind("guild_id", guildConfig.getGuildId().asLong())
            .bind("joined", guildConfig.hasJoined())
            .bind("prefix", guildConfig.getPrefix())
            .execute());
        logger.debug("Created GuildConfig for ID:" + guild.getId().asLong());
        return guildConfig;
    }

    /**
     * Save the provided {@link GuildConfig} to the SQL database.
     * @param config the {@link GuildConfig} to save all properties of
     * @throws Exception when any issue occurs
     */
    public static void saveGuildConfigNow(GuildConfig config) throws Exception {
        AudyDatabase.getJdbi().useHandle(handle ->
            handle.createUpdate("UPDATE guild_data" +
            " SET" +
            " joined = :joined," +
            " prefix = :prefix" +
            " WHERE" +
            " id = :id")
            .bind("joined", config.joined)
            .bind("prefix", config.prefix)
            .bind("id", config.id.asLong())
            .execute());
    }

    /**
     * Get the custom prefix for a single guild.
     * @param guildId snowflake id of the guild to get the prefix for
     * @return the prefix for the guild if it exists
     */
    public static Optional<String> getGuildPrefix(long guildId) {
        return AudyDatabase.getJdbi().withHandle(handle ->
            handle.createQuery("SELECT guild_id, prefix FROM guild_config WHERE guild_id = :guild_id")
                .bind("guild_id", guildId)
                .mapTo(String.class)
                .findOne());
    }

    /**
     * Get all custom guild prefixes from SQL.
     * @return a newly created {@link HashMap} containing every guild ID with a custom prefix as the key
     */
    public static Map<Long, String> getAllGuildPrefixes() throws Exception {
        HashMap<Long, String> prefixMap = new HashMap<>();
        AudyDatabase.getJdbi().useHandle(handle ->
            handle.createQuery("SELECT guild_id, prefix FROM guild_config")
            .map((rs, ctx) -> new Pair<>(rs.getLong("guild_id"), rs.getString("prefix")))
            .list()
            .forEach(pair -> {
                // If the guild has no custom prefix set then don't add it to the Map
                if (pair.getValue() != null) {
                    prefixMap.put(pair.getKey(), pair.getValue());
                }
            }));
        return prefixMap;
    }
}
