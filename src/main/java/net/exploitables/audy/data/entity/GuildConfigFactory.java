/*
 * This file is a part of https://github.com/HunHage/Audy, also known as Audy
 *
 * Audy is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
 * To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or send a letter to
 * Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
 *
 * Audy is provided without any warranty, including any implied warranty.
 */

package net.exploitables.audy.data.entity;

import discord4j.core.event.domain.guild.GuildCreateEvent;
import discord4j.rest.util.Color;
import discord4j.rest.util.Permission;
import net.exploitables.audy.AudyClient;
import net.exploitables.audy.AudyDatabase;
import net.exploitables.audy.AudyMain;
import net.exploitables.audy.data.Pair;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.core.publisher.Mono;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

/**
 * Various methods of obtaining partial Guild Config Data from SQL.
 *
 * Many of the methods present return Mono for compatibility with reactor. The methods themselves
 *  are not reactive and do not benefit from Reactor. A database driver such as r2dbc would be needed.
 *  But for now, JDBI will likely suffice.
 */
public class GuildConfigFactory {
    private static final Logger logger = LoggerFactory.getLogger(GuildConfigFactory.class);

    /**
     * Get the custom prefix for a single guild.
     * @param guildId snowflake id of the guild to get the prefix for
     * @return the prefix for the guild if it exists
     */
    public static Mono<String> getGuildPrefix(long guildId) {
        logger.debug("Fetching guild prefix for: " + guildId);
        try {
            Optional<String> prefix = AudyDatabase.getJdbi().withHandle(handle ->
                handle.createQuery("SELECT pk_guild_id, prefix FROM tbl_guild_config WHERE pk_guild_id = :pk_guild_id")
                    .bind("pk_guild_id", guildId)
                    .mapTo(String.class)
                    .findOne());
            return Mono.justOrEmpty(prefix);
        } catch (Exception e) {
            return Mono.error(e);
        }
    }

    /**
     * Get all custom guild prefixes from SQL.
     * @return a newly created {@link HashMap} containing every guild ID with a custom prefix as the key
     */
    public static Map<Long, String> getAllGuildPrefixes() {
        logger.debug("Fetching all guild prefixes.");
        if (!AudyMain.getConfiguration().isSqlEnabled()) { return new HashMap<>(); }
        HashMap<Long, String> prefixMap = new HashMap<>();
        AudyDatabase.getJdbi().useHandle(handle ->
            handle.createQuery("SELECT pk_guild_id, prefix FROM tbl_guild_config")
            .map((rs, ctx) -> new Pair<>(rs.getLong("pk_guild_id"), rs.getString("prefix")))
            .list()
            .forEach(pair -> {
                // If the guild has no custom prefix set then don't add it to the Map
                if (pair.getValue() != null) {
                    prefixMap.put(pair.getKey(), pair.getValue());
                }
            }));
        return prefixMap;
    }

    /**
     * A guild is "created" when either the bot connects to the gateway and receives the guilds it is in.
     *  Or when the bot is invited to and joins a new guild. Both events are received as a {@link GuildCreateEvent}
     *
     * Check if we haven't send a hello message to the server, if not then the bot has joined a new guild.
     * @param event the event created when joining a new guild or connecting to one already joined
     * @return an empty mono
     */
    public static Mono<Void> onGuildCreateEvent(GuildCreateEvent event) {
        return GuildConfig.getGuildConfig(event.getGuild())
            .filter(guildConfig -> !guildConfig.hasJoined())
            .flatMap(guildConfig -> {
                // Immediately set that we've joined and save the config.
                // Sending the hello message is more luxury than function.
                guildConfig.setJoined();
                return GuildConfig.saveNow(guildConfig)
                    // Log that we joined a guild.
                    .doOnSuccess(booleanSignal -> logger.info("Joined a new guild! ID:" +
                        event.getGuild().getId().asString() + " Name:" + event.getGuild().getName()))
                    // Get the system channel, this is where join messages are posted
                    .flatMap(aBoolean -> event.getGuild().getSystemChannel())
                    // Filter out the channel if Audy doesn't have send message permissions to avoid a 403
                    .filterWhen(textChannel -> textChannel
                            .getEffectivePermissions(AudyClient.getClient().getSelfId())
                            .map(permissions -> permissions.contains(Permission.SEND_MESSAGES)))
                    // At this point if we still have a channel then we have permissions and the system channel is set
                    // Send a hello message
                    .flatMap(channel -> channel.createEmbed(spec -> {
                        spec.setColor(Color.of(AudyMain.getConfiguration().getEmbedColor()));
                        String username = AudyClient.getClient().getSelfUsername();
                        spec.setTitle("Hello, I'm " + username);
                        spec.setDescription("Thank you for inviting me to your server, to see what commands you can " +
                            "use please say `a-help` or `a- help`, if you forget my prefix you can ping me with " +
                            "`@" + username + " help` or `@" + username + " prefix`");
                        spec.setFooter(username + " " + AudyMain.getVersion(), null);
                    }))
                    .then();
            });
    }
}
