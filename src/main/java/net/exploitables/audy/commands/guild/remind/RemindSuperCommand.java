/*
 * This file is a part of https://github.com/HunHage/Audy, also known as Audy
 *
 * Audy is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
 * To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or send a letter to
 * Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
 *
 * Audy is provided without any warranty, including any implied warranty.
 */

package net.exploitables.audy.commands.guild.remind;

import net.exploitables.audy.AudyScheduler;
import net.exploitables.audy.data.bundles.GuildMessageEventBundle;
import net.exploitables.audy.scheduler.ReminderJob;
import org.quartz.*;

import java.sql.Date;
import java.time.Instant;

public class RemindSuperCommand {
    /**
     * Schedule a new reminder for the provided user and channel.
     * @param jobDataMap        A pre-configured {@link JobDataMap} with the following information added:
     *                          userId, channelId, guildId (if channel is in a guild), message (if set), sourceLink
     * @param name              The name of the job.
     * @param group             The group of the job.
     * @param triggerTime       The time this job should start.
     * @throws SchedulerException
     */
    void scheduleReminderOnce(JobDataMap jobDataMap,
                              String name,
                              String group,
                              Instant triggerTime) throws SchedulerException {

        // Quartz seems to have NO way of telling if a job missed it's fire time
        jobDataMap.put("nextFireTime", triggerTime.toEpochMilli());

        JobDetail jobDetail = JobBuilder
            .newJob(ReminderJob.class)
            .withIdentity(name, group)
            .usingJobData(jobDataMap)
            .build();
        Trigger trigger = TriggerBuilder
            .newTrigger()
            .withIdentity(name, group)
            .startAt(Date.from(triggerTime))
            // When missing the scheduled firing time fire ASAP
            .withSchedule(SimpleScheduleBuilder.simpleSchedule().withMisfireHandlingInstructionFireNow())
            .build();

        AudyScheduler.getSqlRemindScheduler().scheduleJob(jobDetail, trigger);
    }

    String createGroupForUser(GuildMessageEventBundle bundle) {
        return "User-" + bundle.getAuthor().getId().asString();
    }
}
