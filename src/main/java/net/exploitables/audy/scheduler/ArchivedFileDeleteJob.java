/*
 * This file is a part of https://github.com/HunHage/Audy, also known as Audy
 *
 * Audy is licensed under the Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License.
 * To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/4.0/ or send a letter to
 * Creative Commons, PO Box 1866, Mountain View, CA 94042, USA.
 *
 * Audy is provided without any warranty, including any implied warranty.
 */

package net.exploitables.audy.scheduler;

import net.exploitables.audy.AudyDatabase;
import net.exploitables.audy.AudyMain;
import org.quartz.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class ArchivedFileDeleteJob implements Job {
    private static Logger logger = LoggerFactory.getLogger(ArchivedFileDeleteJob.class);

    public static void scheduleJobs(Scheduler scheduler) throws SchedulerException {
        logger.info("Scheduling ArchivedFileDeleteJob for scheduler: " + scheduler.getSchedulerName());
        JobDetail jobDetail = JobBuilder
            .newJob(ArchivedFileDeleteJob.class)
            .withIdentity("ArchivedFileDelete", "SqlMaintenance")
            .build();
        SimpleTrigger trigger = TriggerBuilder
            .newTrigger()
            .withIdentity("ArchivedFileDelete", "SqlMaintenance")
            // This means there may be a full 2 hour delay before starting the job, or only a few seconds.
            // This job runs at a minimum of every hour, so this should be OK as if the bot doesn't have the
            //  uptime to execute a job within the next 2 hours consistently there are larger problems afoot.
            .startAt(DateBuilder.evenHourDateAfterNow())
            .withSchedule(SimpleScheduleBuilder.repeatHourlyForever(AudyMain.getConfiguration().getFileDataRetentionInterval()))
            .build();

        scheduler.scheduleJob(jobDetail, trigger);

        logger.info("ArchivedFileDeleteJob scheduled for: " + scheduler.getSchedulerName());
    }

    /**
     * Delete *unused* entries in the ArchivedFile table every Hour.
     * @param context unused for this job
     * @throws JobExecutionException
     */
    @Override
    public void execute(JobExecutionContext context) throws JobExecutionException {
        logger.info("Executing scheduled job to delete unused ArchivedFile entries ...");

        int size = AudyDatabase.getJdbi().withHandle(handle ->
            handle.createQuery("SELECT SUM(octet_length(data_bytes)) FROM tbl_files;")
                .mapTo(Integer.class)
                .findOne().orElse(-1)
            );

        // We can directly delete since tbl_file_links has a primary key which is a foreign key to tbl_files
        int rowsDeleted = AudyDatabase.getJdbi().withHandle(handle ->
            handle.createUpdate("DELETE FROM tbl_files" +
                " WHERE pk_md5 NOT IN (" +
                    " SELECT unnest(linked_files) FROM tbl_message_contents" +
                    " UNION" +
                    " SELECT md5 FROM tbl_message_attachments" +
                " );")
                .execute()
            );

        size -= AudyDatabase.getJdbi().withHandle(handle ->
            handle.createQuery("SELECT SUM(octet_length(data_bytes)) FROM tbl_files;")
                .mapTo(Integer.class)
                .findOne().orElse(-1)
            );

        logger.info("Removed " + rowsDeleted + " rows and freed " + size + " bytes after deleting unused ArchivedFile entries.");
    }
}
